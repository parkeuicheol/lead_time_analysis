import streamlit as st
import pandas as pd
import numpy as np
from functools import reduce
import seaborn as sns
import matplotlib.pyplot as plt
plt.rcParams['font.family'] = 'Malgun Gothic'
import matplotlib as mpl
mpl.rcParams['axes.unicode_minus'] = False
import io, base64, os
import xlsxwriter
from IPython.display import HTML
import shutil
from pyexcelerate import Workbook
import datetime

# ------------------------------------------------------------------
# ì—‘ì…€ ìƒì„±: ì´ë¯¸ì§€ í¬í•¨í•´ì„œ Bytes ë°˜í™˜
# ------------------------------------------------------------------
def to_excel_with_images(df):
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine="xlsxwriter") as writer:
        df.to_excel(writer, sheet_name="Sheet1", index=False)
        workbook = writer.book
        worksheet = writer.sheets["Sheet1"]
        img_cols = ["BOX PLOT(ì›ë³¸)", "BOX PLOT(ì´ìƒì¹˜ ìˆ¨ê¹€)"]
        for col_name in img_cols:
            if col_name not in df.columns:
                continue
            col_idx = df.columns.get_loc(col_name)
            for row_i, html in enumerate(df[col_name]):
                if pd.isna(html):
                    continue
                try:
                    b64 = html.split("base64,")[1].split('"')[0]
                except:
                    continue
                img_data = base64.b64decode(b64)
                img_buf = io.BytesIO(img_data)
                worksheet.insert_image(
                    row_i + 1, col_idx,
                    "",
                    {"image_data": img_buf, "x_scale": 0.5, "y_scale": 0.5, "object_position": 2}
                )
    output.seek(0)
    return output.read()

# ------------------------------------------------------------------
# ë°ì´í„° ë¡œë“œ & ì²˜ë¦¬ (1. íƒ„í•©ì„ ì¬, íƒ„í•©ë´‰ê°•)
# ------------------------------------------------------------------
@st.cache_data
def load_data_tan():
    '''
    1) íƒ„í•©ì„ ì¬ + íƒ„í•©ë´‰ê°•
    - ê°•ì¢…ëŒ€ë¶„ë¥˜: A,B,C,K,M (ëŒ€ê°•ì¢…ëª… == 'íƒ„í•©ê°•')
    - í˜•ìƒ(ì£¼ë¬¸í˜•ìƒ) : WR, RB, FB, SB, HB 
    '''
    # 0) raw_data parquet file import
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°• = pd.read_parquet('1.íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•.parquet')
    master_table = pd.read_parquet('master_table.parquet')
    
    # 1) ê·¸ë£¹ë³„ ìµœëŒ“ê°’ í–‰ ì¶”ì¶œ
    df_max = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•.loc[íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•.groupby('LOT_NO')['ê³µì •ìˆœìœ„'].idxmax(), ['LOT_NO','ê³µì •ìˆœìœ„']]
    
    # 2) ì›ë³¸ ë°ì´í„°í”„ë ˆì„ê³¼ df_max inner merge
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³  = pd.merge(íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•, df_max, on=['LOT_NO','ê³µì •ìˆœìœ„'], how='inner')
    
    # 3) 'ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì' ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° 'ìƒì‚°ì˜ë¢°ë…„ì›”' ì»¬ëŸ¼ê³¼ì˜ ì°¨ì´ ê³„ì‚°
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'] = pd.to_datetime(íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'])
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] = (íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì'] - íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”']).dt.days
    
    # 4) íŒŒìƒë³€ìˆ˜ ìƒì„±
    # ê° ì»¬ëŸ¼ ë°ì´í„°ì˜ ê³µë°±ì„ ì œê±°í•˜ê³ , ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ KEY ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìˆ˜ìš”ê°€í˜•ìƒì£¼ë¬¸ê°•ì¢…'] = (íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ìˆ˜ìš”ê°€ëª…'].str.strip() + 
                                 íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì£¼ë¬¸í˜•ìƒ'].str.strip() + 
                                 íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì£¼ë¬¸ê°•ì¢…ëª…'].str.strip()
                                 )
    
    # ì˜ˆì‹œ: lookup í…Œì´ë¸” DataFrame (ë°ì´í„°í”„ë ˆì„ 'DATA ë¶„ë¥˜ KEY ë° ìš”ì²­ì‚¬í•­'ì—ì„œ Nì—´~Pì—´ ì‚¬ìš©)
    # ì—¬ê¸°ì„œëŠ” ì²« ë²ˆì§¸ ì—´ì„ key, ë‘ ë²ˆì§¸ ì—´ì„ valueë¡œ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
    lookup1 = dict(zip(master_table['key'], master_table['value_1']))
        
    def classify1(r):
        # lookup_dictì—ì„œ "ìˆ˜ìš”ê°€í˜•ìƒì£¼ë¬¸ê°•ì¢…" ê°’ì„ keyë¡œ í•˜ì—¬ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        res = lookup1.get(r['ìˆ˜ìš”ê°€í˜•ìƒì£¼ë¬¸ê°•ì¢…'])
        # # "ì£¼ë¬¸í˜•ìƒ" ê°’ì— ë”°ë¼ ê°’ì„ ì§€ì •
        return res if res else ('íƒ„í•©ì„ ì¬' if r['ì£¼ë¬¸í˜•ìƒ'] == 'WR' else 'íƒ„í•©ë´‰ê°•')
    # ê° í–‰ë§ˆë‹¤ classify1 í•¨ìˆ˜ë¥¼ ì ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì—´ ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ë°©ì‚°êµ¬ë¶„'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .apply(classify1, axis=1)
    
    
    # ì—¬ê¸°ì„œëŠ” ì²« ë²ˆì§¸ ì—´ì„ key, ì„¸ ë²ˆì§¸ ì—´ì„ valueë¡œ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
    lookup2 = dict(zip(master_table['key'], master_table['value_2']))

    def classify2(r):
        # ì¡°ê±´ 1: "ë°©ì‚° êµ¬ë¶„"ì´ "ë°©ì‚°"ì¼ ê²½ìš°
        if r['ë°©ì‚°êµ¬ë¶„']=='ë°©ì‚°':
            return lookup2.get(r['ìˆ˜ìš”ê°€í˜•ìƒì£¼ë¬¸ê°•ì¢…'])
        # ì¡°ê±´ 2: "ë°©ì‚° êµ¬ë¶„"ì´ "íƒ„í•©ì„ ì¬"ì¸ ê²½ìš°
        if r['ë°©ì‚°êµ¬ë¶„']=='íƒ„í•©ì„ ì¬':
            return 'íƒ„í•©ì„ ì¬_ë¹„ì—´ì²˜ë¦¬' if pd.isna(r['ì—´ì²˜ë¦¬']) or r['ì—´ì²˜ë¦¬']=='' else 'íƒ„í•©ì„ ì¬_ì—´ì²˜ë¦¬'
        # "HEAT_NO_êµ¬ë¶„"ê°€ "ESR_HEAT"ì¸ ê²½ìš°
        if r['HEAT_NO_êµ¬ë¶„']=='ESR_HEAT':
            return 'íƒ„í•©ë´‰ê°•_ESR'
        # "ì—´ì²˜ë¦¬"ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ "íƒ„í•©ë´‰ê°•_ë¹„ì—´ì²˜ë¦¬"
        if pd.isna(r['ì—´ì²˜ë¦¬']) or r['ì—´ì²˜ë¦¬']=='':
            return 'íƒ„í•©ë´‰ê°•_ë¹„ì—´ì²˜ë¦¬'
        return 'íƒ„í•©ë´‰ê°•_QT' if r['ì—´ì²˜ë¦¬']=='QT' else 'íƒ„í•©ë´‰ê°•_ì—´ì²˜ë¦¬' # "ì—´ì²˜ë¦¬"ê°’ì´ "QT"ì´ë©´ "íƒ„í•©ë´‰ê°•_QT", ê·¸ ì™¸ë©´ "íƒ„í•©ë´‰ê°•_ì—´ì²˜ë¦¬"
    
    # ê° í–‰ë§ˆë‹¤ classify2 í•¨ìˆ˜ë¥¼ ì ìš©í•˜ì—¬ ìƒˆë¡œìš´ 'ê²°ê³¼' ì»¬ëŸ¼ ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œí’ˆêµ¬ë¶„'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .apply(classify2, axis=1)

    # ê° ì»¬ëŸ¼ ë°ì´í„°ì˜ ê³µë°±ì„ ì œê±°í•˜ê³ , ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ KEY ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['KEY'] = (
        íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œí’ˆêµ¬ë¶„'].str.strip() + '_'
        + íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['í’ˆì¢…'].str.strip() + '_'
        + íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì£¼ë¬¸í˜•ìƒ'].str.strip() + '_'
        + íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['í‘œë©´'].str.strip()
        )
    
    # 5) í†µê³„ì¹˜ ê³„ì‚°
    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ ê³ ìœ ê°’(nunique) ê°¯ìˆ˜ë¥¼ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_A = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['LOT_NO'].nunique().reset_index(name='KEYë³„ LOT ê°¯ìˆ˜')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ í•©ì‚°(sum)ì„ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_B = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì…ê³ ì¤‘ëŸ‰'].sum().reset_index(name='KEY ì´ ì¤‘ëŸ‰')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ì•™ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_C = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].median().reset_index(name='ì œì¡°ê³µê¸°_ì¤‘ì•™ê°’')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 1ë¶„ìœ„ìˆ˜(25th percentile)ë¥¼ ê³„ì‚°í•˜ê³ ,
    # ê·¸ ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_D = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.25).reset_index(name='ì œì¡°ê³µê¸°_1ë¶„ìœ„ìˆ˜')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 75ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜(3ë¶„ìœ„ìˆ˜)ë¥¼ ê³„ì‚° í›„,
    # ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_E = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.75).reset_index(name='ì œì¡°ê³µê¸°_3ë¶„ìœ„ìˆ˜')

    # ê·¸ë£¹ë³„ë¡œ (Q1 - 1.5Ã—IQR) ~ (Q3 + 1.5Ã—IQR) êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” ê°’ë“¤ì˜ í‰ê· ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    def avg_iqr(series):
        q1, q3 = series.quantile(0.25), series.quantile(0.75)
        iqr = q3-q1
        return series[(series>=q1-1.5*iqr)&(series<=q3+1.5*iqr)].mean()
    result_F = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].apply(avg_iqr).reset_index(name='ì œì¡°ê³µê¸°_(Q1-1.5IQR~Q3+1.5IQR)_í‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ í‰ê· ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_G = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].mean().reset_index(name='ì œì¡°ê³µê¸°_ë‹¨ìˆœí‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³  = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .merge(result_B, on='KEY')
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰']/íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['KEY ì´ ì¤‘ëŸ‰']
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']*íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜']
    result_H = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'].sum().reset_index(name='KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³  = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .merge(result_H, on='KEY')
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] - íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ']
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] ** 2
    íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰'] * íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2']

    # ê·¸ë£¹í•‘í•œ í›„, Bì™€ C ì»¬ëŸ¼ì˜ í•©ê³„ë¥¼ ê³„ì‚°    
    result_I = íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY').agg({'ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰':'sum','ì…ê³ ì¤‘ëŸ‰':'sum'}).reset_index()

    # ê° ê·¸ë£¹ë³„ë¡œ B í•©ê³„ê°’ì„ C í•©ê³„ê°’ìœ¼ë¡œ ë‚˜ëˆˆ ê°’(ë¹„ìœ¨)ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ ì»¬ëŸ¼ ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'] = result_I['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] / result_I['ì…ê³ ì¤‘ëŸ‰']
    
    # íŠ¹ì •ì»¬ëŸ¼ì˜ ì œê³±ê·¼ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ íŒŒìƒë³€ìˆ˜ "íŠ¹ì •ì»¬ëŸ¼_ì œê³±ê·¼" ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘_í‘œì¤€í¸ì°¨'] = np.sqrt(result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'])

    # 8) final summary dataframe ìƒì„±
    # ë°ì´í„°í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    dfs = [result_A, result_B, result_C, result_D, result_E, result_F, result_G, result_H, result_I]
    merged_df = reduce(lambda l,r: pd.merge(l,r,on='KEY'), dfs)
    
    # 9) boxplot ì´ë¯¸ì§€ ìƒì„±
    def make_img(series, show_outliers=True):
        buf=io.BytesIO(); fig,ax=plt.subplots(figsize=(8,4));
        ax.boxplot(series, vert=False, showfliers=show_outliers)
        ax.axis('off'); fig.savefig(buf,format='png',bbox_inches='tight'); plt.close(fig);buf.seek(0)
        return base64.b64encode(buf.getvalue()).decode()
    imgs = [{'KEY':k,
             'BOX PLOT(ì›ë³¸)':f'<img src="data:image/png;base64,{make_img(g)}"/>',
             'BOX PLOT(ì´ìƒì¹˜ ìˆ¨ê¹€)':f'<img src="data:image/png;base64,{make_img(g,False)}"/>'}
            for k,g in íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']]
    img_df = pd.DataFrame(imgs)

    # 10) final summary dataframeê³¼ img_df merge
    merged_df = merged_df.merge(img_df, on='KEY')

    # 11) KEYë³„ LOT ê°¯ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    merged_df = merged_df.sort_values(by='KEYë³„ LOT ê°¯ìˆ˜', ascending=False).reset_index(drop=True)
    return merged_df

# ------------------------------------------------------------------
# ë°ì´í„° ë¡œë“œ & ì²˜ë¦¬ (2. STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ)
# ------------------------------------------------------------------
@st.cache_data
def load_data_sts():
    '''
    2) STSë´‰ê°• + íŠ¹ìˆ˜í•©ê¸ˆ
    - ê°•ì¢…ëŒ€ë¶„ë¥˜: S, V
    - í˜•ìƒ: RB, FB, SB, HB
    '''
    # 0) raw_data parquet file import
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ = pd.read_parquet('2.STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ.parquet')
    
    # 1) ê·¸ë£¹ë³„(ê³µì •ìˆœìœ„ê°€ ìµœëŒ€ì¸ í–‰)ì˜ ì¸ë±ìŠ¤ë¥¼ êµ¬í•œ ë’¤, í•´ë‹¹ í–‰ë§Œ ì¶”ì¶œ
    df_max = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ.loc[STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ.groupby('LOT_NO')['ê³µì •ìˆœìœ„'].idxmax(), ['LOT_NO','ê³µì •ìˆœìœ„']]
    
    # 2) ì›ë³¸ ë°ì´í„°í”„ë ˆì„ê³¼ df_max inner merge
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³  = pd.merge(STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ, df_max, on=['LOT_NO','ê³µì •ìˆœìœ„'], how='inner')
    
    # 3) 'ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì' ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° 'ìƒì‚°ì˜ë¢°ë…„ì›”' ì»¬ëŸ¼ê³¼ì˜ ì°¨ì´ ê³„ì‚°
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'] = pd.to_datetime(STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'])
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] = (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì'] - STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”']).dt.days
    
    # 4) íŒŒìƒë³€ìˆ˜ ìƒì„± (ì—´ì²˜ë¦¬_êµ¬ë¶„)
    # ì¡°ê±´ ì •ì˜
    conditions = [
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì—´ì²˜ë¦¬']=='NH') | (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì—´ì²˜ë¦¬'].isna()),
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì—´ì²˜ë¦¬']=='QT')
    ]
    
    # ê° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê°’ ëª©ë¡
    choices = ['N',  # ì²« ë²ˆì§¸ ì¡°ê±´ì— í•´ë‹¹í•˜ë©´ 'N'
               'Y(QT)' # ë‘ ë²ˆì§¸ ì¡°ê±´ì— í•´ë‹¹í•˜ë©´ 'Y(QT)'
               ]
    
    # ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ê²½ìš° 'Y'
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì—´ì²˜ë¦¬_êµ¬ë¶„'] = np.select(conditions, choices, default='Y')
    
    # 5) íŒŒìƒë³€ìˆ˜ ìƒì„± (í˜•ìƒ_êµ¬ë¶„)
    # ì¡°ê±´ ì •ì˜
    conditions = [(STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì£¼ë¬¸í˜•ìƒ']=='FB')]
    
    # ê° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê°’ ëª©ë¡
    choices = ['FB']
    
    # ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ê²½ìš° 'RB'
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['í˜•ìƒ_êµ¬ë¶„'] = np.select(conditions, choices, default='RB')
    
    # 5) íŒŒìƒë³€ìˆ˜ ìƒì„± (íŠ¹ìˆ˜ì œê°•_êµ¬ë¶„)
    # ì¡°ê±´ ì„¤ì •
    conditions = [
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['HEAT_NO_êµ¬ë¶„']=='ESR_HEAT') & (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ëª¨HEAT_NO'].str.startswith('K')),
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['HEAT_NO_êµ¬ë¶„']=='VAR_HEAT') & (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ëª¨HEAT_NO'].str.startswith('K')),
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['HEAT_NO_êµ¬ë¶„'].isin(['ì†Œí˜•_VIM_HEAT','ì¤‘í˜•_VIM_HEAT'])),
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['HEAT_NO_êµ¬ë¶„']=='VAR_HEAT') & (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ëª¨HEAT_NO'].str.startswith('N')),
        (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['HEAT_NO_êµ¬ë¶„']=='ESR_HEAT') & (STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ëª¨HEAT_NO'].str.startswith('N'))
    ]
    
    # ê° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ê°’ ëª©ë¡
    choices = ['VIM-ESR','VIM-VAR','VIM','VAR','ESR']
    
    # ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ê²½ìš° defaultë¡œ None í• ë‹¹
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['íŠ¹ìˆ˜ì œê°•_êµ¬ë¶„'] = np.select(conditions, choices, default='None')
    
    # 6) íŒŒìƒë³€ìˆ˜ ìƒì„± : ê° ì»¬ëŸ¼ ë°ì´í„°ì˜ ê³µë°±ì„ ì œê±°í•˜ê³ , ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ KEY ìƒì„±
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['KEY'] = (
        STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì—´ì²˜ë¦¬_êµ¬ë¶„'].str.strip() + "_" +
        STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['í˜•ìƒ_êµ¬ë¶„'].str.strip() + "_" + 
        STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['íŠ¹ìˆ˜ì œê°•_êµ¬ë¶„'].str.strip()
        )
    
    # 7) í†µê³„ì¹˜ ê³„ì‚°
    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ ê³ ìœ ê°’(nunique) ê°¯ìˆ˜ë¥¼ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_A = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['LOT_NO'].nunique().reset_index(name='KEYë³„ LOT ê°¯ìˆ˜')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ í•©ì‚°(sum)ì„ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_B = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì…ê³ ì¤‘ëŸ‰'].sum().reset_index(name='KEY ì´ ì¤‘ëŸ‰')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ì•™ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_C = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].median().reset_index(name='ì œì¡°ê³µê¸°_ì¤‘ì•™ê°’')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 1ë¶„ìœ„ìˆ˜(25th percentile)ë¥¼ ê³„ì‚°í•˜ê³ ,
    # ê·¸ ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_D = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.25).reset_index(name='ì œì¡°ê³µê¸°_1ë¶„ìœ„ìˆ˜')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 75ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜(3ë¶„ìœ„ìˆ˜)ë¥¼ ê³„ì‚° í›„,
    # ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_E = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.75).reset_index(name='ì œì¡°ê³µê¸°_3ë¶„ìœ„ìˆ˜')

    # ê·¸ë£¹ë³„ë¡œ (Q1 - 1.5Ã—IQR) ~ (Q3 + 1.5Ã—IQR) êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” ê°’ë“¤ì˜ í‰ê· ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    def avg_iqr(series):
        q1, q3 = series.quantile(0.25), series.quantile(0.75)
        iqr = q3-q1
        return series[(series>=q1-1.5*iqr)&(series<=q3+1.5*iqr)].mean()
    result_F = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].apply(avg_iqr).reset_index(name='ì œì¡°ê³µê¸°_(Q1-1.5IQR~Q3+1.5IQR)_í‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ í‰ê· ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_G = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].mean().reset_index(name='ì œì¡°ê³µê¸°_ë‹¨ìˆœí‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³  = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .merge(result_B, on='KEY')
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜'] = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰']/STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['KEY ì´ ì¤‘ëŸ‰']
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'] = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']*STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜']
    result_H = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'].sum().reset_index(name='KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³  = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .merge(result_H, on='KEY')
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] - STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ']
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2'] = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] ** 2
    STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰'] * STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2']

    # ê·¸ë£¹í•‘í•œ í›„, Bì™€ C ì»¬ëŸ¼ì˜ í•©ê³„ë¥¼ ê³„ì‚°    
    result_I = STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY').agg({'ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰':'sum','ì…ê³ ì¤‘ëŸ‰':'sum'}).reset_index()

    # ê° ê·¸ë£¹ë³„ë¡œ B í•©ê³„ê°’ì„ C í•©ê³„ê°’ìœ¼ë¡œ ë‚˜ëˆˆ ê°’(ë¹„ìœ¨)ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ ì»¬ëŸ¼ ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'] = result_I['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] / result_I['ì…ê³ ì¤‘ëŸ‰']
    
    # íŠ¹ì •ì»¬ëŸ¼ì˜ ì œê³±ê·¼ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ íŒŒìƒë³€ìˆ˜ "íŠ¹ì •ì»¬ëŸ¼_ì œê³±ê·¼" ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘_í‘œì¤€í¸ì°¨'] = np.sqrt(result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'])

    # 8) final summary dataframe ìƒì„±
    # ë°ì´í„°í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    dfs = [result_A, result_B, result_C, result_D, result_E, result_F, result_G, result_H, result_I]
    merged_df = reduce(lambda l,r: pd.merge(l,r,on='KEY'), dfs)
    
    # 9) boxplot ì´ë¯¸ì§€ ìƒì„±
    def make_img(series, show_outliers=True):
        buf=io.BytesIO(); fig,ax=plt.subplots(figsize=(6,2));
        ax.boxplot(series, vert=False, showfliers=show_outliers)
        ax.axis('off'); fig.savefig(buf,format='png',bbox_inches='tight'); plt.close(fig);buf.seek(0)
        return base64.b64encode(buf.getvalue()).decode()
    imgs = [{'KEY':k,
             'BOX PLOT(ì›ë³¸)':f'<img src="data:image/png;base64,{make_img(g)}"/>',
             'BOX PLOT(ì´ìƒì¹˜ ìˆ¨ê¹€)':f'<img src="data:image/png;base64,{make_img(g,False)}"/>'}
            for k,g in STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']]
    img_df = pd.DataFrame(imgs)

    # 10) final summary dataframeê³¼ img_df merge
    merged_df = merged_df.merge(img_df, on='KEY')

    # 11) KEYë³„ LOT ê°¯ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    merged_df = merged_df.sort_values(by='KEYë³„ LOT ê°¯ìˆ˜', ascending=False).reset_index(drop=True)
    return merged_df

# ------------------------------------------------------------------
# ë°ì´í„° ë¡œë“œ & ì²˜ë¦¬ (3. STSì„ ì¬)
# ------------------------------------------------------------------
@st.cache_data
def load_data_sts_wr():
    '''
    3) STSì„ ì¬ 
    - ê°•ì¢…ëŒ€ë¶„ë¥˜ : S,V
    - í˜•ìƒ: WR
    '''
    # 0) raw_data parquet file import
    STSì„ ì¬ = pd.read_parquet('3.STSì„ ì¬.parquet')
    
    # 1) ê·¸ë£¹ë³„(ê³µì •ìˆœìœ„ê°€ ìµœëŒ€ì¸ í–‰)ì˜ ì¸ë±ìŠ¤ë¥¼ êµ¬í•œ ë’¤, í•´ë‹¹ í–‰ë§Œ ì¶”ì¶œ
    df_max = STSì„ ì¬.loc[STSì„ ì¬.groupby('LOT_NO')['ê³µì •ìˆœìœ„'].idxmax(), ['LOT_NO','ê³µì •ìˆœìœ„']]
    
    # 2) ì›ë³¸ ë°ì´í„°í”„ë ˆì„ê³¼ df_max inner merge
    STSì„ ì¬_ì…ê³  = pd.merge(STSì„ ì¬, df_max, on=['LOT_NO','ê³µì •ìˆœìœ„'], how='inner')
    
    # 3) 'ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì' ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° 'ìƒì‚°ì˜ë¢°ë…„ì›”' ì»¬ëŸ¼ê³¼ì˜ ì°¨ì´ ê³„ì‚°
    STSì„ ì¬_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'] = pd.to_datetime(STSì„ ì¬_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'])
    STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] = (STSì„ ì¬_ì…ê³ ['ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì'] - STSì„ ì¬_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”']).dt.days
    
    # 4) íŒŒìƒë³€ìˆ˜ ìƒì„±
    # ì—¬ëŸ¬ ì¡°ê±´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
    conditions = [
        # "ì‚°ì„¸_200ê³„": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SF"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ 'S','N','E' ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SF")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('S','N','E'))),
        
        # "ì‚°ì„¸_300ê³„": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SS"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ 'S','N','E' ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SS")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('S','N','E'))),
        
        # "ì‚°ì„¸_400ê³„": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SM"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ 'S','N','E' ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SM")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('S','N','E'))),
        
        # "ì‚°ì„¸_ë‚´ì—´ê°•": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SU"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ 'S','N','E' ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SU")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('S','N','E'))),
        
        # "ì‚°ì„¸_íŠ¹ìˆ˜í•©ê¸ˆ": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'V'ì´ê³ , í‘œë©´ì´ "P"ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'V') &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")),
        
        # "íŠ¹ìˆ˜ì •ë ¨_ì‚°ì„¸_300ê³„": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SS"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ ('K','H','R','V') ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SS")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('K','H','R','V'))),
        
        # "íŠ¹ìˆ˜ì •ë ¨_ì‚°ì„¸_400ê³„": ëŒ€ê°•ì¢…ì½”ë“œê°€ 'S', ì‚¬ë‚´ê°•ì¢…ì´ "SM"ë¡œ ì‹œì‘, í‘œë©´ì´ "P"ë¡œ ì‹œì‘, HEAT_NOê°€ ('K','H','R','V') ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘
        (STSì„ ì¬_ì…ê³ ['ëŒ€ê°•ì¢…ì½”ë“œ'] == 'S') &
        (STSì„ ì¬_ì…ê³ ['ì‚¬ë‚´ê°•ì¢…'].str.startswith("SM")) &
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("P")) &
        (STSì„ ì¬_ì…ê³ ['HEAT_NO'].str.startswith(('K','H','R','V'))),
        
        # "í‘í”¼_ë¹„ì—´ì²˜ë¦¬": í‘œë©´ì´ "B"ë¡œ ì‹œì‘í•˜ê³ , ì—´ì²˜ë¦¬ ì»¬ëŸ¼ì´ ê²°ì¸¡ì¹˜ì¸ ê²½ìš°
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("B")) &
        (STSì„ ì¬_ì…ê³ ['ì—´ì²˜ë¦¬'].isna()),
        
        # "í‘í”¼_ì—´ì²˜ë¦¬": í‘œë©´ì´ "B"ë¡œ ì‹œì‘í•˜ê³ , ì—´ì²˜ë¦¬ ì»¬ëŸ¼ì— ê°’ì´ ìˆëŠ” ê²½ìš°
        (STSì„ ì¬_ì…ê³ ['í‘œë©´'].str.startswith("B")) &
        (STSì„ ì¬_ì…ê³ ['ì—´ì²˜ë¦¬'].notna())
        ]

    # ê° ì¡°ê±´ì— ëŒ€ì‘í•˜ëŠ” ë ˆì´ë¸”(ì¶œë ¥ê°’) ë¦¬ìŠ¤íŠ¸
    choices = [
        "ì‚°ì„¸_200ê³„",
        "ì‚°ì„¸_300ê³„",
        "ì‚°ì„¸_400ê³„",      # ì£¼ì„ê³¼ ë§ì¶”ì–´ "ì‚°ì„¸_400ê³„"ë¡œ ìˆ˜ì •(ì›ë³¸ ì½”ë“œì—ì„œëŠ” "ì‚°ì„¸_300ê³„"ì˜€ìŒ)
        "ì‚°ì„¸_ë‚´ì—´ê°•",
        "ì‚°ì„¸_íŠ¹ìˆ˜í•©ê¸ˆ",
        "íŠ¹ìˆ˜ì •ë ¨_ì‚°ì„¸_300ê³„",
        "íŠ¹ìˆ˜ì •ë ¨_ì‚°ì„¸_400ê³„",
        "í‘í”¼_ë¹„ì—´ì²˜ë¦¬",
        "í‘í”¼_ì—´ì²˜ë¦¬"
        ]

    # np.selectë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°ê±´ì— ë§ëŠ” ë ˆì´ë¸” í• ë‹¹ (ì–´ë–¤ ì¡°ê±´ì—ë„ í•´ë‹¹í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’(default) Noneì„ í• ë‹¹)
    STSì„ ì¬_ì…ê³ ['KEY'] = np.select(conditions, choices, default=None)

    # 5) í†µê³„ì¹˜ ê³„ì‚°
    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ ê³ ìœ ê°’(nunique) ê°¯ìˆ˜ë¥¼ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_A = STSì„ ì¬_ì…ê³ .groupby('KEY')['LOT_NO'].nunique().reset_index(name='KEYë³„ LOT ê°¯ìˆ˜')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ í•©ì‚°(sum)ì„ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_B = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì…ê³ ì¤‘ëŸ‰'].sum().reset_index(name='KEY ì´ ì¤‘ëŸ‰')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ì•™ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_C = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].median().reset_index(name='ì œì¡°ê³µê¸°_ì¤‘ì•™ê°’')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 1ë¶„ìœ„ìˆ˜(25th percentile)ë¥¼ ê³„ì‚°í•˜ê³ ,
    # ê·¸ ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_D = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.25).reset_index(name='ì œì¡°ê³µê¸°_1ë¶„ìœ„ìˆ˜')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 75ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜(3ë¶„ìœ„ìˆ˜)ë¥¼ ê³„ì‚° í›„,
    # ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_E = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.75).reset_index(name='ì œì¡°ê³µê¸°_3ë¶„ìœ„ìˆ˜')

    # ê·¸ë£¹ë³„ë¡œ (Q1 - 1.5Ã—IQR) ~ (Q3 + 1.5Ã—IQR) êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” ê°’ë“¤ì˜ í‰ê· ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    def avg_iqr(series):
        q1, q3 = series.quantile(0.25), series.quantile(0.75)
        iqr = q3-q1
        return series[(series>=q1-1.5*iqr)&(series<=q3+1.5*iqr)].mean()
    result_F = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].apply(avg_iqr).reset_index(name='ì œì¡°ê³µê¸°_(Q1-1.5IQR~Q3+1.5IQR)_í‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ í‰ê· ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_G = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].mean().reset_index(name='ì œì¡°ê³µê¸°_ë‹¨ìˆœí‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    STSì„ ì¬_ì…ê³  = STSì„ ì¬_ì…ê³ .merge(result_B, on='KEY')
    STSì„ ì¬_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜'] = STSì„ ì¬_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰']/STSì„ ì¬_ì…ê³ ['KEY ì´ ì¤‘ëŸ‰']
    STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'] = STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']*STSì„ ì¬_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜']
    result_H = STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'].sum().reset_index(name='KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    STSì„ ì¬_ì…ê³  = STSì„ ì¬_ì…ê³ .merge(result_H, on='KEY')
    STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] = STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] - STSì„ ì¬_ì…ê³ ['KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ']
    STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2'] = STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] ** 2
    STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] = STSì„ ì¬_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰'] * STSì„ ì¬_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2']

    # ê·¸ë£¹í•‘í•œ í›„, Bì™€ C ì»¬ëŸ¼ì˜ í•©ê³„ë¥¼ ê³„ì‚°    
    result_I = STSì„ ì¬_ì…ê³ .groupby('KEY').agg({'ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰':'sum','ì…ê³ ì¤‘ëŸ‰':'sum'}).reset_index()

    # ê° ê·¸ë£¹ë³„ë¡œ B í•©ê³„ê°’ì„ C í•©ê³„ê°’ìœ¼ë¡œ ë‚˜ëˆˆ ê°’(ë¹„ìœ¨)ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ ì»¬ëŸ¼ ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'] = result_I['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] / result_I['ì…ê³ ì¤‘ëŸ‰']
    
    # íŠ¹ì •ì»¬ëŸ¼ì˜ ì œê³±ê·¼ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ íŒŒìƒë³€ìˆ˜ "íŠ¹ì •ì»¬ëŸ¼_ì œê³±ê·¼" ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘_í‘œì¤€í¸ì°¨'] = np.sqrt(result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'])

    # 8) final summary dataframe ìƒì„±
    # ë°ì´í„°í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    dfs = [result_A, result_B, result_C, result_D, result_E, result_F, result_G, result_H, result_I]
    merged_df = reduce(lambda l,r: pd.merge(l,r,on='KEY'), dfs)
    
    # 9) boxplot ì´ë¯¸ì§€ ìƒì„±
    def make_img(series, show_outliers=True):
        buf=io.BytesIO(); fig,ax=plt.subplots(figsize=(6,2));
        ax.boxplot(series, vert=False, showfliers=show_outliers)
        ax.axis('off'); fig.savefig(buf,format='png',bbox_inches='tight'); plt.close(fig);buf.seek(0)
        return base64.b64encode(buf.getvalue()).decode()
    imgs = [{'KEY':k,
             'BOX PLOT(ì›ë³¸)':f'<img src="data:image/png;base64,{make_img(g)}"/>',
             'BOX PLOT(ì´ìƒì¹˜ ìˆ¨ê¹€)':f'<img src="data:image/png;base64,{make_img(g,False)}"/>'}
            for k,g in STSì„ ì¬_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']]
    img_df = pd.DataFrame(imgs)

    # 10) final summary dataframeê³¼ img_df merge
    merged_df = merged_df.merge(img_df, on='KEY')

    # 11) KEYë³„ LOT ê°¯ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    merged_df = merged_df.sort_values(by='KEYë³„ LOT ê°¯ìˆ˜', ascending=False).reset_index(drop=True)
    return merged_df



# ------------------------------------------------------------------
# ë°ì´í„° ë¡œë“œ & ì²˜ë¦¬ (4. ê¸ˆí˜•/ê³µêµ¬ê°•)
# ------------------------------------------------------------------
@st.cache_data
def load_data_tool():
    '''
    4) ê³µêµ¬ê°•/ê¸ˆí˜•ê°•
    - ê°•ì¢…ëŒ€ë¶„ë¥˜: T
    - í˜•ìƒ : ALL
    '''
    # 0) raw_data parquet file import
    ê³µêµ¬_ê¸ˆí˜•ê°• = pd.read_parquet('4.ê³µêµ¬_ê¸ˆí˜•ê°•.parquet')
    
    # 1) ê·¸ë£¹ë³„(ê³µì •ìˆœìœ„ê°€ ìµœëŒ€ì¸ í–‰)ì˜ ì¸ë±ìŠ¤ë¥¼ êµ¬í•œ ë’¤, í•´ë‹¹ í–‰ë§Œ ì¶”ì¶œ
    df_max = ê³µêµ¬_ê¸ˆí˜•ê°•.loc[ê³µêµ¬_ê¸ˆí˜•ê°•.groupby('LOT_NO')['ê³µì •ìˆœìœ„'].idxmax(), ['LOT_NO','ê³µì •ìˆœìœ„']]
    
    # 2) ì›ë³¸ ë°ì´í„°í”„ë ˆì„ê³¼ df_max inner merge
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³  = pd.merge(ê³µêµ¬_ê¸ˆí˜•ê°•, df_max, on=['LOT_NO','ê³µì •ìˆœìœ„'], how='inner')
    
    # 3) 'ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì' ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ë° 'ìƒì‚°ì˜ë¢°ë…„ì›”' ì»¬ëŸ¼ê³¼ì˜ ì°¨ì´ ê³„ì‚°
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'] = pd.to_datetime(ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”'])
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] = (ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ìƒì‚°ì •ë³´_ì‘ì—…ì¼ì'] - ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ìƒì‚°ì˜ë¢°ë…„ì›”']).dt.days
    
    # 4) íŒŒìƒë³€ìˆ˜ ìƒì„± (ì…ê³ ì‹œê¸°)
    # ì¡°ê±´ì„¤ì •
    def determine_quarter(date_str):
        """
        date_str: "YYYY-MM" í˜•ì‹ì˜ ë¬¸ìì—´ ì˜ˆ: "2024-10"
        ë°˜í™˜: "YYë…„ Xë¶„ê¸°" (ì˜ˆ: "24ë…„ 4ë¶„ê¸°") ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨ ì‹œ None
        """
        try:
            # date_strì„ datetime ê°ì²´ë¡œ ë³€í™˜ (ì¼ìëŠ” ë¬´ì‹œ)
            dt = datetime.datetime.strptime(date_str, "%Y-%m")
        except ValueError:
            return None
        
        # (month - 1) // 3 + 1 ë¥¼ ì´ìš©í•´ ë¶„ê¸°ë¥¼ ê³„ì‚° (1~3ì›”: 1ë¶„ê¸°, ...)
        quarter = (dt.month - 1) // 3 + 1
        # ì—°ë„ëŠ” ë‘ ìë¦¬ë¡œ ë³€í™˜í•˜ì—¬ ë ˆì´ë¸” ìƒì„±
        return f"{dt.year % 100:02d}ë…„ {quarter}ë¶„ê¸°"

    # íŒŒìƒì»¬ëŸ¼ ê°’ì— ëŒ€í•´ í•¨ìˆ˜ ì ìš©í•˜ì—¬ Y ì»¬ëŸ¼ ìƒì„±
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ì…ê³ ì‹œê¸°"] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ì…ê³ ë…„ì›”"].apply(determine_quarter)

    # 5) íŒŒìƒë³€ìˆ˜ ìƒì„± (ê°•ì¢…êµ¬ë¶„ KEY)
    # ì¡°ê±´ì„¤ì •
    def categorize(ì‚¬ë‚´ê°•ì¢…ëª…, ì£¼ë¬¸í˜•ìƒ):
        # ì¡°ê±´ 1: ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "STD"ë¡œ ì‹œì‘í•˜ë©´
        if isinstance(ì‚¬ë‚´ê°•ì¢…ëª…, str) and ì‚¬ë‚´ê°•ì¢…ëª….startswith("STD"):
            return "STD11_61ì¢…"
        # ì¡°ê±´ 2: ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "SMATE", "SMATF", "SMATV" ì¤‘ í•˜ë‚˜ë©´
        elif ì‚¬ë‚´ê°•ì¢…ëª… in ("SMATE", "SMATF", "SMATV"):
            return ì‚¬ë‚´ê°•ì¢…ëª…
        # ì¡°ê±´ 3: ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "TP"ë¡œ ì‹œì‘í•˜ë©´
        elif isinstance(ì‚¬ë‚´ê°•ì¢…ëª…, str) and ì‚¬ë‚´ê°•ì¢…ëª….startswith("TP"):
            return "TPê³„ì—´"
        # ì¡°ê±´ 4: ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "THKT"ë¡œ ì‹œì‘í•˜ë©´
        elif isinstance(ì‚¬ë‚´ê°•ì¢…ëª…, str) and ì‚¬ë‚´ê°•ì¢…ëª….startswith("THKT"):
            return "SKS4ê³„ì—´"
        # ì¡°ê±´ 5: ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "D2" ë˜ëŠ” "S7" ì´ê±°ë‚˜, ì‚¬ë‚´ê°•ì¢…ëª… ê°’ì´ "W2"ë¡œ ì‹œì‘í•˜ë©´
        elif (ì‚¬ë‚´ê°•ì¢…ëª… in ("D2", "S7")) or (isinstance(ì‚¬ë‚´ê°•ì¢…ëª…, str) and ì‚¬ë‚´ê°•ì¢…ëª….startswith("W2")):
            return "ìˆ˜ì¶œëŒ€ìƒ"
        # ì¡°ê±´ 6: ì£¼ë¬¸í˜•ìƒ ê°’ì´ "FK"ì´ë©´
        elif ì£¼ë¬¸í˜•ìƒ == "FK":
            return "FK"
        # ë‚˜ë¨¸ì§€ ê²½ìš°
        else:
            return "ê¸°íƒ€_ì¬ë¶„ë¥˜"

    # applyë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ ì—´ 'Y' ìƒì„±
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ê°•ì¢…êµ¬ë¶„ KEY"] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .apply(lambda row: categorize(row["ì‚¬ë‚´ê°•ì¢…ëª…"], row["ì£¼ë¬¸í˜•ìƒ"]), axis=1)

    # 6) íŒŒìƒë³€ìˆ˜ ìƒì„± (ì¢…í•© ìµœì¢… KEY)
    # ì¡°ê±´ì„¤ì •
    # 'í’ˆì¢…', 'ì£¼ë¬¸í˜•ìƒ', 'í‘œë©´' ì»¬ëŸ¼ì˜ ê³µë°±ì„ ì œê±°í•˜ê³ , ê° ì»¬ëŸ¼ì„ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ KEY ìƒì„±
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["KEY"] = (
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ì…ê³ ì‹œê¸°"].str.strip().astype(str) + "_" +
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ê°•ì¢…êµ¬ë¶„ KEY"].str.strip().astype(str) + "_" +
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["í’ˆì¢…"].str.strip().astype(str) + "_" +
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ì£¼ë¬¸í˜•ìƒ"].str.strip().astype(str) + "_" +
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["ì—´ì²˜ë¦¬"].str.strip().astype(str) + "_" +
        ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ["í‘œë©´"].str.strip().astype(str)
    )

    # 7) í†µê³„ì¹˜ ê³„ì‚°
    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ ê³ ìœ ê°’(nunique) ê°¯ìˆ˜ë¥¼ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_A = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['LOT_NO'].nunique().reset_index(name='KEYë³„ LOT ê°¯ìˆ˜')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ Bì»¬ëŸ¼ì˜ í•©ì‚°(sum)ì„ ê³„ì‚° í›„, ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_B = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì…ê³ ì¤‘ëŸ‰'].sum().reset_index(name='KEY ì´ ì¤‘ëŸ‰')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ì•™ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_C = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].median().reset_index(name='ì œì¡°ê³µê¸°_ì¤‘ì•™ê°’')

    # Aì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 1ë¶„ìœ„ìˆ˜(25th percentile)ë¥¼ ê³„ì‚°í•˜ê³ ,
    # ê·¸ ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_D = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.25).reset_index(name='ì œì¡°ê³µê¸°_1ë¶„ìœ„ìˆ˜')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ 75ë²ˆì§¸ ë°±ë¶„ìœ„ìˆ˜(3ë¶„ìœ„ìˆ˜)ë¥¼ ê³„ì‚° í›„,
    # ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrameìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
    result_E = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].quantile(0.75).reset_index(name='ì œì¡°ê³µê¸°_3ë¶„ìœ„ìˆ˜')

    # ê·¸ë£¹ë³„ë¡œ (Q1 - 1.5Ã—IQR) ~ (Q3 + 1.5Ã—IQR) êµ¬ê°„ì— í•´ë‹¹í•˜ëŠ” ê°’ë“¤ì˜ í‰ê· ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    def avg_iqr(series):
        q1, q3 = series.quantile(0.25), series.quantile(0.75)
        iqr = q3-q1
        return series[(series>=q1-1.5*iqr)&(series<=q3+1.5*iqr)].mean()
    result_F = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].apply(avg_iqr).reset_index(name='ì œì¡°ê³µê¸°_(Q1-1.5IQR~Q3+1.5IQR)_í‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ í‰ê· ê°’ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    result_G = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'].mean().reset_index(name='ì œì¡°ê³µê¸°_ë‹¨ìˆœí‰ê· ')
    
    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³  = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .merge(result_B, on='KEY')
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜'] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰']/ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['KEY ì´ ì¤‘ëŸ‰']
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']*ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ê°€ì¤‘ê³„ìˆ˜']
    result_H = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°*ê°€ì¤‘ê³„ìˆ˜'].sum().reset_index(name='KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ')

    # A ì»¬ëŸ¼ì„ ê·¸ë£¹í•‘í•˜ì—¬ ê° ê·¸ë£¹ë³„ B ì»¬ëŸ¼ì˜ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ì„ ê³„ì‚°í•˜ê³  ê²°ê³¼ë¥¼ ìƒˆë¡œìš´ DataFrame ìƒì„±
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³  = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .merge(result_H, on='KEY')
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)'] - ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['KEYë³„ ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ']
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2'] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· '] ** 2
    ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì…ê³ ì¤‘ëŸ‰'] * ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ ['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2']

    # ê·¸ë£¹í•‘í•œ í›„, Bì™€ C ì»¬ëŸ¼ì˜ í•©ê³„ë¥¼ ê³„ì‚°    
    result_I = ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY').agg({'ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰':'sum','ì…ê³ ì¤‘ëŸ‰':'sum'}).reset_index()

    # ê° ê·¸ë£¹ë³„ë¡œ B í•©ê³„ê°’ì„ C í•©ê³„ê°’ìœ¼ë¡œ ë‚˜ëˆˆ ê°’(ë¹„ìœ¨)ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ ì»¬ëŸ¼ ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'] = result_I['ì œì¡°ê³µê¸°-ì¤‘ëŸ‰ê°€ì¤‘í‰ê· ^2 * ê° LOTì¤‘ëŸ‰'] / result_I['ì…ê³ ì¤‘ëŸ‰']
    
    # íŠ¹ì •ì»¬ëŸ¼ì˜ ì œê³±ê·¼ì„ ê³„ì‚°í•˜ì—¬ ìƒˆë¡œìš´ íŒŒìƒë³€ìˆ˜ "íŠ¹ì •ì»¬ëŸ¼_ì œê³±ê·¼" ìƒì„±
    result_I['ì¤‘ëŸ‰ê°€ì¤‘_í‘œì¤€í¸ì°¨'] = np.sqrt(result_I['ì¤‘ëŸ‰ê°€ì¤‘ë¶„ì‚°'])

    # 8) final summary dataframe ìƒì„±
    # ë°ì´í„°í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    dfs = [result_A, result_B, result_C, result_D, result_E, result_F, result_G, result_H, result_I]
    merged_df = reduce(lambda l,r: pd.merge(l,r,on='KEY'), dfs)
    
    # 9) boxplot ì´ë¯¸ì§€ ìƒì„±
    def make_img(series, show_outliers=True):
        buf=io.BytesIO(); fig,ax=plt.subplots(figsize=(6,2));
        ax.boxplot(series, vert=False, showfliers=show_outliers)
        ax.axis('off'); fig.savefig(buf,format='png',bbox_inches='tight'); plt.close(fig);buf.seek(0)
        return base64.b64encode(buf.getvalue()).decode()
    imgs = [{'KEY':k,
             'BOX PLOT(ì›ë³¸)':f'<img src="data:image/png;base64,{make_img(g)}"/>',
             'BOX PLOT(ì´ìƒì¹˜ ìˆ¨ê¹€)':f'<img src="data:image/png;base64,{make_img(g,False)}"/>'}
            for k,g in ê³µêµ¬_ê¸ˆí˜•ê°•_ì…ê³ .groupby('KEY')['ì œì¡°ê³µê¸°(ì…ê³ ì¼-ìƒì‚°ì˜ë¢°ë…„ì›”ì¼)']]
    img_df = pd.DataFrame(imgs)

    # 10) final summary dataframeê³¼ img_df merge
    merged_df = merged_df.merge(img_df, on='KEY')

    # 11) KEYë³„ LOT ê°¯ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    merged_df = merged_df.sort_values(by='KEYë³„ LOT ê°¯ìˆ˜', ascending=False).reset_index(drop=True)
    return merged_df

# ------------------------------------------------------------------
# Streamlit UI
# ------------------------------------------------------------------
st.set_page_config(page_title="ì…ê³  ë¶„ì„ ì•±", layout="wide")
st.title("ë¶„ì„ ê²°ê³¼ í…Œì´ë¸”")

# ë°ì´í„° ì„ íƒ
dataset = st.sidebar.radio("ë¶„ì„í•  ë°ì´í„° ì„ íƒ", ("1.íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•", "2.STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ", "3.STSì„ ì¬", "4.ê³µê¸ˆ_ê¸ˆí˜•ê°•"))

with st.spinner("ë°ì´í„° ë¡œë“œ ì¤‘..."):
    if dataset == "1.íƒ„í•©ì„ ì¬_íƒ„í•©ë´‰ê°•":
        df = load_data_tan()
    elif dataset == "2.STSë´‰ê°•_íŠ¹ìˆ˜í•©ê¸ˆ":
        df = load_data_sts()
    elif dataset == "3.STSì„ ì¬":
        df = load_data_sts_wr()
    elif dataset == "4.ê³µê¸ˆ_ê¸ˆí˜•ê°•":
        df = load_data_tool()
    else:
        st.error("ë°ì´í„°ì…‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")

# KEY í•„í„°ë§
all_keys = df['KEY'].unique().tolist()
selected = st.sidebar.multiselect("ğŸ”‘ í•„í„°í•  KEY ì„ íƒ", all_keys, default=all_keys[:5])
if selected:
    df = df[df['KEY'].isin(selected)]
else:
    st.sidebar.warning("í•˜ë‚˜ ì´ìƒì˜ KEYë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.")

# í…Œì´ë¸” ì¶œë ¥
# st.markdown("### ë¶„ì„ ê²°ê³¼ í…Œì´ë¸”")
st.write(df.to_html(escape=False, index=False), unsafe_allow_html=True)

# ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
excel_data = to_excel_with_images(df)
st.download_button("ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ", data=excel_data, file_name=f"{dataset}_ë¶„ì„ê²°ê³¼.xlsx", mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
